@using IT_Hardware.Controllers
@{
    ViewBag.Title = "Index";
}
@model IT_Hardware.Areas.Admin.Models.Proposal_details


<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script src="~/js/commonjs.js"></script>
<link href="~/css/commoncssclass.css" rel="stylesheet" />


<style type="text/css">

    .hidetable {
        display: none;
    }


    .btn_download {
        display: inline-block;
        outline: 0;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 14px;
        font-weight: 300;
        line-height: 10px;
        vertical-align: middle;
        border: 1px solid;
        border-radius: 6px;
        color: #ffffff;
        background-color: #2ea44f;
        border-color: #1b1f2326;
        box-shadow: rgba(27, 31, 35, 0.04) 0px 1px 0px 0px, rgba(255, 255, 255, 0.25) 0px 1px 0px 0px inset;
        transition: 0.2s cubic-bezier(0.3, 0, 0.5, 1);
        transition-property: color, background-color, border-color;
    }

        .btn_download:hover {
            background-color: rgb(155 221 30 / 0.73);
            border-color: #1b1f2326;
            transition-duration: 0.1s;
        }

    .row {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .block {
        width: 100px;
    }

</style>


<div style="text-align: center; height: 50px; align-content: center; width: 100% " class="h-10 w-100 shadow p-1 mb-1 bg-white rounded">

    <p style="font-size:large; font-weight:bold;">Update Proposal Status</p>

</div>

<div style=" align-content:center; width:100%" class="h-10 w-100 shadow p-1 mb-1 bg-white rounded">

        <table class=" table-hover table-striped shadow " style="width:100%">
            <tr>
                <td style="width:100%;  text-align:center;" colspan="4">
                    <table style="width:100%;" class=" table-hover table-striped shadow " id="tbl_statusGrid">
                        <thead>
                            <tr class="table-active">
                                <td style="font-weight:bold; width: 10%; text-align:left; " class=""> 
                                    @Html.HiddenFor(x => x.Proposal_Id)    Date</td>
                                <td style="font-weight:bold; width: 15%; text-align:left; "> Sender </td>
                                <td style="font-weight:bold; width: 15%; text-align:left; "> Receiver </td>
                                <td style="font-weight:bold; width: 15%; text-align:center; "> File </td>
                                <td style="font-weight:bold; width: 40%; text-align:center;"> Remarks </td>
                                <td style="font-weight:bold; width: 5%;  text-align:center;"> Action </td>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.WorkFlowList)
                            {

                                <tr>
                                    <td style="width: 10%; text-align:left; ">
                                        @Html.DisplayFor(modelItem => item.SendDate)
                                    </td>
                                    <td style="width: 15%; text-align:left; ">
                                        @Html.DisplayFor(modelItem => item.FromDte)
                                    </td>
                                    <td style="width: 15%; text-align:left; ">
                                        @Html.DisplayFor(modelItem => item.ToDte)
                                    </td>
                                    <td style="width: 15%; text-align:left; ">
                                        @Html.DisplayFor(modelItem => item.WorkFlow_File)
                                    </td>
                                    <td style="width: 40%; text-align:left; ">
                                        @Html.DisplayFor(modelItem => item.Remarks)
                                    </td>
                                    <td style="width: 5%; text-align:center; ">
                                        @if(item.LastRow==1)
                                        {
                                            <input type='submit' value='Delete' class='btn_delete deleteGridRow' id='@item.WorkFlow_Id'>
                                        }

                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td style="width: 10%; text-align:left; ">
                                    @Html.TextBoxFor(x => x.Work_Flow.SendDate, "{0:dd/MM/yyyy}", new { @class = "dateclass form-rounded date-format", @style = " width :95%; " })
                                </td>
                                <td style="width: 15%; text-align:left; ">
                                    @Html.DropDownListFor(x => x.Work_Flow.FromDte, Model.Department_List, new { @class = " form-rounded", @style = " width :95%; " })
                                </td>
                                <td style="width: 15%; text-align:left; ">
                                    @Html.DropDownListFor(x => x.Work_Flow.ToDte, Model.Department_List, new { @class = " form-rounded", @style = " width :95%; " })
                                 </td>
                                <td style="width: 15%; text-align:left; ">
                                    <input type="file" id="WorkFlow_File" name="WorkFlow_File"  /> 
                                </td>
                                <td style="width: 40%; text-align:left; ">
                                    @Html.TextAreaFor(x => x.Work_Flow.Remarks, new { @class = " ", @style = " width :95%; " })
                                </td>
                                <td style="width: 5%; text-align:center; ">
                                    <input type='submit' value='Submit' class='button_cls form-rounded' id='btn_SaveFlow'>
                                </td>
                            </tr>
                        </tfoot>
                  </table>
                </td>
            </tr>
            <tr>
                <td style="width:100%; height:20px;" colspan="4">
                </td>
            </tr>
            <tr style=" height: 50px; ">
                <td align="left" style="width:25%; ">Final Approval File</td>
                <td style="width: 75%;" colspan="3">
                    <table style="width: 100%;">
                        <tr>
                            <td style="width:100%;" colspan="3">
                                <input type="file" name="postedFile" id="FileUpload_Id" />
                                <input type="submit" id="btnFileUpload" class="btn_download" value="Upload" />
                                <progress id="fileProgress" style="display: none"></progress>
                                <span id="lblMessage" style="color: Green"></span>
                            </td>
                        </tr>
                        <tr><td colspan="3" style="height:10px;"></td></tr>
                        <tr>
                            <td>
                                <table id="Files_Grid" style="width:100%;">
                                    <tr>
                                        <td style="width:50%; font-weight:bold">File Name</td>
                                        <td style="width: 25%; font-weight: bold"> Download</td>
                                        <td style="width: 25%; font-weight: bold"> Delete</td>
                                    </tr>

                                    @foreach (var item in Model.Prop_Files)
                                    {
                                        <tr>
                                            <td class='filename'>
                                                <p>@Html.DisplayFor(modelItem => item.File_Name)</p>
                                            </td>
                                            <td>
                                                <input type='submit' value='Download' class='cssdownload btn_download' id='@item.File_Id' />
                                            </td>
                                            <td>
                                                <input type='submit' class='appDetails btn_delete' id='@item.File_Id' value='Delete' />
                                            </td>
                                        </tr>
                                    }
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>            
            </tr>

            <tr>
                <td style="width:100%; height:20px;" colspan="4">
                </td>
            </tr>
            <tr style=" height: 50px; ">
                <td style="width:25%" >
                    Status
                </td>
                <td align="center" style="text-align:center; align-items:center;width:25%">
                    @Html.DropDownListFor(x => x.Work_Flow.FromDte, Model.Status_List, new { @class = " form-rounded", @style = " width :90%; " })
                </td>
                <td style="width:25%; text-align:center;">
                    <input type='submit' value='Save Status' class='button_cls form-rounded' id='btn_SaveFlow'>
                </td>
                <td style="align-self:right" align="right">
                    @Html.ActionLink("Back", "Admin_Dashboard", "Admin_Dashboard", null, new { @class = "button_cls form-rounded", })
                </td>
            </tr>
        </table>

</div>

@* ---------------------------------------Grid Save Delete--------------------------------------------------------------- *@

<script type="text/javascript">
    

    $(function () {

        $('#btn_SaveFlow').click(function (event) {


            var SendDate= $('#Work_Flow_SendDate').val();
            var FromDte= $('#Work_Flow_FromDte').val();
            var ToDte= $('#Work_Flow_ToDte').val();
            var Remarks= $('#Work_Flow_Remarks').val();
            var WorkFlow_File= $('#WorkFlow_File').get(0).files;

         

            $.ajax({
                type: "POST",
                url: "@Url.Action("AddWorkFlow", "Admin_Dashboard")",
                datatype: "Json",
                data: { ProposalId: $('#Proposal_Id').val(), "data.SendDate": SendDate, "data.FromDte":FromDte , "data.ToDte": ToDte , 
                                            "data.Remarks": Remarks , "data.WorkFlow_File": WorkFlow_File },
                contentType: false,
                processData: false,
                cache: false,
                success: function (data) {
                    alert('test');
                   // Bind_WorkFlow ( data );
                }
            });

            event.preventDefault();
        });
    });



@* --------------------------------------------Delete GridRow------------------------------------------- *@

    $(function () {

        $('.deleteGridRow').click(function (event) {

             var workflow_Id = $(this).attr('id');
             //var proposal = $('#Proposal_Id').val();

            $.ajax({
                type: "POST",
                url: "@Url.Action("DeleteWorkFlow", "Admin_Dashboard")",
                datatype: "Json",
                data: { WorkFlow_Id: workflow_Id, ProposalId: $('#Proposal_Id').val() },
                success: function (data) {
                     Bind_WorkFlow ( data );
                }
            });
        });
    });



    function Bind_WorkFlow ( data )
    {
        $("#tbl_statusGrid tbody tr").remove();
        // $.each(data, function (index, value) {

        // });
    };

 </script>

@*------------------------------------ File Function--------------------------------------------------------------*@

<script type="text/javascript">
    
$(function () {

        $('#btnFileUpload').click(function (event) {


            if (window.FormData !== undefined) {

                var fileUpload = $("#FileUpload_Id").get(0);
                var files = fileUpload.files;

                var fileRefId = $("#Proposal_Id").val();

                // Create FormData object
                var fileData = new FormData();

                // Looping over all files and add it to FormData object
                for (var i = 0; i < files.length; i++) {
                    fileData.append(files[i].name, files[i]);
                }

                fileData.append('Proposal_Id', fileRefId);

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("FiliUpload", "Admin_Dashboard")",
                    datatype: "Json",
                    data: fileData,
                    contentType: false, // Not to set any content header
                    processData: false, // Not to process data
                    success: function (response) {
                        if (response.key == '') {
                            alert('');
                        }
                        else {
                            $("#Files_Grid tr").remove();
                            markup = "<tr><th style='width: 50%;'> File Name </th> <th style='width: 25%;'> Download </th> <th style='width: 25%; text-align: center'> Delete </th> </tr>";
                            tableBody = $("#Files_Grid tbody");
                            tableBody.append(markup);

                            if (response != null) {
                                $.each(response, function (key, val) {
                                    markup = "<tr><td class='filename'> <p>" + val.file_Name + "</p> </td> " +
                                        "<td>  <input type='submit' value='Download' class='cssdownload btn_download' id='" + val.file_Id + "' > </input> </td> " +
                                        "<td style=' text-align: center'>  <input type='submit' class='appDetails btn_delete' id='" + val.file_Id + "' value='Delete' > </input> </td></tr> "

                                    tableBody = $("#Files_Grid tbody");
                                    tableBody.append(markup);
                                });
                            }
                        }
                    },
                    error: function (err) {
                        alert(err.statusText);
                    }
                });
            }
            event.preventDefault();
        });
    });

</script>


<script type="text/javascript">
    $(function () {

        $(document).on("click", ".appDetails", function () {
            var clickedBtnID = $(this).attr('id');

            var fileRefId = $("#Proposal_Id").val();

            if (confirm('Are you sure you want to delete this?')) {

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("DeleteFile", "Admin_Dashboard")",
                    datatype: "Json",
                    data: { FileId: clickedBtnID, RefId: fileRefId },
                    success: function (response) {


                        $("#Files_Grid tr").remove();

                        markup = "<tr><th style='width: 50%;'> File Name </th> <th style='width: 25%;'> Download </th> <th style='width: 25%; text-align: center'> Delete </th> </tr>";
                        tableBody = $("#Files_Grid tbody");
                        tableBody.append(markup);


                        if (response != null) {

                            $.each(response, function (key, val) {

                                markup = "<tr><td> " + val.file_Name + " </td> " +
                                    "<td>  <input type='submit' value='Download' class='cssdownload btn_download' id='" + val.file_Id + "' > </input> </td> " +
                                    "<td style=' text-align: center'>  <input type='submit' class='appDetails btn_delete' id='" + val.file_Id + "' value='Delete' > </input> </td></tr> "

                                tableBody = $("#Files_Grid tbody");
                                tableBody.append(markup);

                            });
                        }


                    },
                    error: function (err) {
                        alert(err.statusText);
                    }

                });

            }

            event.preventDefault();

        });
    });
</script>


<script type="text/javascript">
    $(document).on("click", ".cssdownload", function () {
        
        var fileID = $(this).attr('id');
        var FileName = $(this).closest("tr")   // Finds the closest row <tr>
                       .find(".filename")
                       .find("p")
                       .text();
        $.ajax({
            type: "POST",
            url: "@Url.Action("Download", "Admin_Dashboard")",
            data: { fileName: fileID },
            success: function (r) {
                //Convert Base64 string to Byte Array.
                var bytes = Base64ToBytes(r);

                //Convert Byte Array to BLOB.
                var blob = new Blob([bytes], { type: "application/octetstream" });

                //Check the Browser type and download the File.
                var isIE = false || !!document.documentMode;
                if (isIE) {
                    window.navigator.msSaveBlob(blob, FileName);
                }
                else {
                    var url = window.URL || window.webkitURL;
                    link = url.createObjectURL(blob);
                    var a = $("<a />");
                    a.attr("download", FileName);
                    a.attr("href", link);
                    $("body").append(a);
                    a[0].click();
                    $("body").remove(a);
                }
            }
        });

        event.preventDefault();

    });

    function Base64ToBytes(base64) {
        var s = window.atob(base64);
        var bytes = new Uint8Array(s.length);
        for (var i = 0; i < s.length; i++) {
            bytes[i] = s.charCodeAt(i);
        }
        return bytes;
    };

</script>

@*---------------------------------------------------------------------------------------------------------------*@


